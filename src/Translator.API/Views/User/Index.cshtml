@model IEnumerable<Translator.Application.Features.Users.Queries.GetUsers.Response>

@{
ViewBag.Title = "Users";
Layout = "_Layout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Users <small class="text-muted" id="totalCountInfo">(@(Model?.Count() ?? 0) total)</small></h2>
    <div class="d-flex align-items-center">
        <!-- Search Box -->
        <div class="input-group me-3" style="width: 300px;">
            <input type="text" class="form-control" id="userSearch" placeholder="Search by username..."
                   aria-label="Search users">
            <button class="btn btn-outline-secondary" type="button" id="clearSearch" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <button type="button" class="btn btn-primary" onclick="showCreateModal()">
            <i class="fas fa-plus"></i> Create User
        </button>
    </div>
</div>

<!-- Alert container -->
<div id="alertContainer">
    @if (TempData["SuccessMessage"] != null)
    {
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    }
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-body" style="padding:0;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th scope="col">Username</th>
                    <th scope="col">User ID</th>
                    <th scope="col">Secret Key</th>
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                @if (Model != null && Model.Any())
                {
                foreach (var user in Model)
                {
                <tr>
                    <td>
                        <span class="fw-bold">@user.UserName</span>
                    </td>
                    <td>
                        <code class="text-muted">@user.UserId</code>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <code class="me-2 secret-key" data-key="@user.SecretKey">••••••••••••••••</code>
                            <button class="btn btn-sm btn-outline-secondary toggle-secret"
                                    onclick="toggleSecretKey(this, '@Html.Raw(Html.Encode(user.SecretKey))')"
                                    title="Show/Hide Secret Key">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary ms-1 copy-secret"
                                    onclick="copySecretKey('@Html.Raw(Html.Encode(user.SecretKey))')"
                                    title="Copy Secret Key">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger"
                                onclick="showDeleteModal('@Html.Raw(Html.Encode(user.UserName))')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                }
                }
                else
                {
                <tr id="emptyState">
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <div>No users found</div>
                    </td>
                </tr>
                }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="d-flex justify-content-between align-items-center p-3 border-top">
            <div class="text-muted" id="pageInfo">
                Showing 0 of 0 users
            </div>
            <nav>
                <ul class="pagination mb-0" id="paginationControls">
                    <!-- Pagination will be dynamically generated -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> A unique secret key will be generated automatically for the new user.
                </div>
                <div class="mb-3">
                    <label for="createUsername" class="form-label">Username</label>
                    <input type="text" class="form-control" id="createUsername"
                           placeholder="Enter username" maxlength="50">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCreateBtn">
                    <i class="fas fa-plus"></i> Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone. All data associated with this user will be permanently deleted.
                </div>
                <div class="user-info">
                    <p><strong>Username:</strong> <span id="usernameToDelete"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Secret Key Display Modal -->
<div class="modal fade" id="secretKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Created Successfully!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Success:</strong> User has been created successfully!
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Important:</strong> Please save this secret key securely. It will not be shown again.
                </div>
                <div class="mb-3">
                    <label class="form-label">Secret Key:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newUserSecretKey" readonly>
                        <button class="btn btn-outline-primary" type="button" onclick="copyText('newUserSecretKey')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
            </div>
        </div>
    </div>
</div>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // Global variables
    let currentPage = 1;
    let currentPageSize = 10;
    let currentSearchTerm = '';
    let searchTimeout = null;

    // Initialize when DOM is ready
    $(document).ready(function() {
        // Bind events for modals
        bindModalEvents();

        // Initialize search functionality
        initSearch();

        // Load initial data
        loadUsers();

        // Auto-hide TempData alerts
        autoHideAlerts();
    });

    function bindModalEvents() {
        // Create modal button
        $('#confirmCreateBtn').on('click', function() {
            const username = $('#createUsername').val().trim();
            createUser(username);
        });

        // Delete modal button
        $('#confirmDeleteBtn').on('click', function() {
            const username = $('#usernameToDelete').text();
            deleteUser(username);
        });

        // Enter key in create username field
        $('#createUsername').on('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const username = $(this).val().trim();
                createUser(username);
            }
        });
    }

    function initSearch() {
        // Search with debounce
        $('#userSearch').on('input', function() {
            currentSearchTerm = $(this).val().trim();

            // Show/hide clear button
            $('#clearSearch').toggle(currentSearchTerm.length > 0);

            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Set new timeout for debounce (1000ms = 1 second)
            searchTimeout = setTimeout(function() {
                currentPage = 1; // Reset to first page when searching
                loadUsers();
            }, 1000);
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#userSearch').val('');
            currentSearchTerm = '';
            $(this).hide();
            currentPage = 1;
            loadUsers();
        });

        // Handle Enter key in search
        $('#userSearch').on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                currentPage = 1;
                loadUsers();
            }
        });
    }

    function autoHideAlerts() {
        const successAlert = $('.alert-success');
        if (successAlert.length) {
            setTimeout(() => {
                const alert = new bootstrap.Alert(successAlert[0]);
                alert.close();
            }, 5000);
        }

        const errorAlert = $('.alert-danger');
        if (errorAlert.length) {
            setTimeout(() => {
                const alert = new bootstrap.Alert(errorAlert[0]);
                alert.close();
            }, 5000);
        }
    }

    function loadUsers() {
        console.log('Loading users... Page:', currentPage, 'Search:', currentSearchTerm);

        // Show loading state
        $('#usersTableBody').html(`
        <tr id="loadingState">
            <td colspan="4" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Loading users...</div>
            </td>
        </tr>
    `);

        // Prepare request data
        const requestData = {
            userName: currentSearchTerm || null,
            pageNumber: currentPage,
            pageSize: currentPageSize
        };

        // AJAX call using jQuery
        $.ajax({
            url: '/Users/Search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log('Response received:', response);

                if (response.success) {
                    renderUsers(response.data);
                    renderPagination(response);
                    updatePageInfo(response);
                } else {
                    showError(response.message || 'Failed to load users');
                    renderEmptyState();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading users:', error);
                showError('Network error: ' + error);
                renderEmptyState();
            }
        });
    }

    function renderUsers(users) {
        const tbody = $('#usersTableBody');
        tbody.empty();

        if (users && users.length > 0) {
            users.forEach(function(user) {
                const row = createUserRow(user);
                tbody.append(row);
            });
        } else {
            renderEmptyState();
        }
    }

    function createUserRow(user) {
        const username = escapeHtml(user.userName);
        const normalizedUsername = user.userName.toLowerCase().trim();
        const userId = escapeHtml(user.userId);
        const secretKey = escapeHtml(user.secretKey);
        const isCompanyWebsiteUser = normalizedUsername === "company website";

        let deleteButton = '';
        if (!isCompanyWebsiteUser) {
            deleteButton = `
            <button class="btn btn-sm btn-outline-danger"
                    onclick="showDeleteModal('${username}')"
                    title="Delete user">
                <i class="fas fa-trash"></i> Delete
            </button>
        `;
        } else {
            deleteButton = `
            <button class="btn btn-sm btn-secondary disabled"
                    title="Company Website user cannot be deleted">
                <i class="fas fa-lock"></i> Protected
            </button>
        `;
        }

        return `
    <tr>
        <td>
            <span class="fw-bold">${username}</span>
            ${isCompanyWebsiteUser ? '<span class="badge bg-warning text-dark ms-2">Protected</span>' : ''}
        </td>
        <td>
            <code class="text-muted">${userId}</code>
        </td>
        <td>
            <div class="d-flex align-items-center">
                <code class="me-2 secret-key" data-key="${secretKey}">••••••••••••••••</code>
                <button class="btn btn-sm btn-outline-secondary toggle-secret"
                        onclick="toggleSecretKey(this, '${secretKey}')"
                        title="Show/Hide Secret Key">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary ms-1 copy-secret"
                        onclick="copySecretKey('${secretKey}')"
                        title="Copy Secret Key">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </td>
        <td>
            ${deleteButton}
        </td>
    </tr>
`;
    }

    function renderPagination(response) {
        const pagination = $('#paginationControls');
        pagination.empty();

        if (!response || response.totalPages <= 1) {
            $('#paginationContainer').hide();
            return;
        }

        $('#paginationContainer').show();

        // Previous button
        const prevDisabled = !response.hasPreviousPage ? 'disabled' : '';
        pagination.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" ${prevDisabled}>
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);

        // Page numbers
        const totalPages = response.totalPages;
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust start if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // First page
        if (startPage > 1) {
            pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(1)">1</a>
            </li>
            ${startPage > 2 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
        `);
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            pagination.append(`
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
        }

        // Last page
        if (endPage < totalPages) {
            pagination.append(`
            ${endPage < totalPages - 1 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>
            </li>
        `);
        }

        // Next button
        const nextDisabled = !response.hasNextPage ? 'disabled' : '';
        pagination.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" ${nextDisabled}>
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);
    }

    function updatePageInfo(response) {
        if (!response) return;

        const startItem = (response.page - 1) * response.pageSize + 1;
        const endItem = Math.min(response.page * response.pageSize, response.totalItems);

        $('#pageInfo').html(`
        Showing <strong>${startItem}-${endItem}</strong> of <strong>${response.totalItems}</strong> users
        ${currentSearchTerm ? `for "<strong>${escapeHtml(currentSearchTerm)}</strong>"` : ''}
    `);

        // Update total count in header
        $('#totalCountInfo').text(`(${response.totalItems} total)`);
    }

    function changePage(page) {
        if (page !== currentPage && page >= 1) {
            currentPage = page;
            loadUsers();
        }
    }

    function renderEmptyState() {
        const tbody = $('#usersTableBody');
        const message = currentSearchTerm
            ? `No users found for "${escapeHtml(currentSearchTerm)}"`
            : 'No users found';

        tbody.html(`
        <tr id="emptyState">
            <td colspan="4" class="text-center text-muted py-4">
                <i class="fas fa-users fa-3x mb-3"></i>
                <div>${message}</div>
                ${currentSearchTerm ? '<div class="mt-2"><button class="btn btn-sm btn-outline-secondary" onclick="clearSearch()">Clear search</button></div>' : ''}
            </td>
        </tr>
    `);

        // Hide pagination when empty
        $('#paginationContainer').hide();
    }

    function clearSearch() {
        $('#userSearch').val('');
        currentSearchTerm = '';
        $('#clearSearch').hide();
        currentPage = 1;
        loadUsers();
    }

    // Modal Functions
    function showCreateModal() {
        const modal = new bootstrap.Modal($('#createUserModal')[0]);
        modal.show();
        $('#createUsername').focus();
    }

    function showDeleteModal(username) {
        $('#usernameToDelete').text(username);
        const modal = new bootstrap.Modal($('#deleteUserModal')[0]);
        modal.show();
    }

    // User CRUD Operations
    async function createUser(username) {
        if (!username) {
            showValidationError('createUsername', 'Username is required');
            return;
        }

        const btn = $('#confirmCreateBtn');
        btn.prop('disabled', true);

        try {
            const response = await $.ajax({
                url: '/Users/Create',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userName: username })
            });

            if (response.success) {
                // Close create modal
                const createModal = $('#createUserModal');
                const bsModal = bootstrap.Modal.getInstance(createModal[0]);
                if (bsModal) bsModal.hide();

                // Show secret key modal
                $('#newUserSecretKey').val(response.secretKey);
                const secretKeyModal = new bootstrap.Modal($('#secretKeyModal')[0]);
                secretKeyModal.show();

                // Clear form
                $('#createUsername').val('');
                clearValidationError('createUsername');

                // Reload data with current search/filters
                loadUsers();

                // Show success message
                showSuccess(response.message || 'User created successfully');
            } else {
                showError(response.message);
            }
        } catch (error) {
            console.error('Error creating user:', error);
            showError('Failed to create user: ' + error.responseJSON?.message || error.statusText);
        } finally {
            btn.prop('disabled', false);
        }
    }

    async function deleteUser(username) {
        const btn = $('#confirmDeleteBtn');
        btn.prop('disabled', true);

        try {
            const response = await $.ajax({
                url: '/Users/Delete',
                type: 'POST',
                data: { username: username },
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.success) {
                showSuccess(response.message);

                const modal = $('#deleteUserModal');
                const bsModal = bootstrap.Modal.getInstance(modal[0]);
                if (bsModal) bsModal.hide();

                loadUsers();
            } else {
                showError(response.message);
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            showError('Failed to delete user: ' + error.responseJSON?.message || error.statusText);
        } finally {
            btn.prop('disabled', false);
        }
    }

    // Secret Key Functions
    function toggleSecretKey(button, secretKey) {
        const codeElement = $(button).parent().find('.secret-key');
        const icon = $(button).find('i');

        if (codeElement.text() === '••••••••••••••••') {
            codeElement.text(secretKey);
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
            button.title = 'Hide Secret Key';
        } else {
            codeElement.text('••••••••••••••••');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
            button.title = 'Show Secret Key';
        }
    }

    function copySecretKey(secretKey) {
        navigator.clipboard.writeText(secretKey).then(() => {
            const button = $(event.target).closest('button');
            const originalHtml = button.html();
            button.html('<i class="fas fa-check"></i>');
            button.removeClass('btn-outline-primary').addClass('btn-success');

            setTimeout(() => {
                button.html(originalHtml);
                button.removeClass('btn-success').addClass('btn-outline-primary');
            }, 1000);
        });
    }

    function copyText(elementId) {
        const element = $('#' + elementId);
        navigator.clipboard.writeText(element.val()).then(() => {
            const button = $(event.target).closest('button');
            const originalHtml = button.html();
            button.html('<i class="fas fa-check"></i> Copied!');
            button.addClass('btn-success');

            setTimeout(() => {
                button.html(originalHtml);
                button.removeClass('btn-success');
            }, 1000);
        });
    }

    // Utility Functions
    function showValidationError(fieldId, message) {
        const field = $('#' + fieldId);
        const feedback = field.parent().find('.invalid-feedback');
        field.addClass('is-invalid');
        feedback.text(message);
    }

    function clearValidationError(fieldId) {
        const field = $('#' + fieldId);
        const feedback = field.parent().find('.invalid-feedback');
        field.removeClass('is-invalid');
        feedback.text('');
    }

    function showAlert(message, type) {
        const container = $('#alertContainer');
        container.html(`
        <div class="alert alert-${type} alert-dismissible fade show">
            ${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            container.find('.alert').alert('close');
        }, 5000);
    }

    function showSuccess(message) {
        showAlert(message, 'success');
    }

    function showError(message) {
        showAlert(message, 'danger');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = $('<div></div>').text(text);
        return div.html();
    }
</script>

<style>
    .user-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .secret-key {
        font-family: 'Courier New', monospace;
        font-size: 0.875em;
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        cursor: default;
    }

    .toggle-secret, .copy-secret {
        transition: all 0.2s ease;
    }

    .toggle-secret:hover, .copy-secret:hover {
        transform: scale(1.05);
    }

    #paginationContainer {
        background-color: #f8f9fa;
    }

    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .page-link {
        color: #007bff;
        cursor: pointer;
    }

    .page-link:hover {
        color: #0056b3;
        background-color: #e9ecef;
    }

    .page-item.disabled .page-link {
        color: #6c757d;
        cursor: not-allowed;
    }

    #userSearch:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    #clearSearch:hover {
        background-color: #e9ecef;
    }

    #loadingState .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    .badge {
        font-size: 0.75em;
    }

    .disabled {
        cursor: not-allowed !important;
        opacity: 0.65;
    }
</style>