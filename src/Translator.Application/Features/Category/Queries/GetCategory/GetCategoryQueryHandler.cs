using MediatR;
using Microsoft.EntityFrameworkCore;
using Translator.Application.Exceptions;
using Translator.Infrastructure.Database.Postgres;
using Translator.Infrastructure.Database.Postgres.Repository;
using CategoryEntity = Translator.Domain.DataModels.Category;

namespace Translator.Application.Features.Category.Queries.GetCategory;

public class GetCategoryQueryHandler(IRepository<CategoryEntity> _categoryRepository)
    : IRequestHandler<GetCategoryQuery, CategoryReadDto>
{
    public async Task<CategoryReadDto> Handle(GetCategoryQuery request, CancellationToken cancellationToken)
    {
        var category = await _categoryRepository
            .AsQueryable()
            .Include(c => c.Children)
            .FirstOrDefaultAsync(c => c.Id == request.Id, cancellationToken);

        if(category is null)
            throw new CategoryNotFoundException(request.Id);
        
        return MapToReadDto(category);
    }

    private CategoryReadDto MapToReadDto(CategoryEntity category)
    {
        var dto = new CategoryReadDto(category.Id, category.Value, category.Type, category.Order, category.ParentId);
        
        if (category.Children is not null)
            dto.Children = category.Children.Select(c => MapToReadDto(c)).ToList();

        return dto;
    }
}

public record CategoryReadDto(Guid Id, string Value, string Type, int? Order, Guid? ParentId)
{
    public List<CategoryReadDto> Children { get; set; } = [];
}